服务器端保存会话数据的弊端
---------------------------

### 烫手的山芋，问题多多

* 如果是应用服务器进程内保存，那么能保存多少会话，每个会话能允许保存多少数据，需要算计
* 会话存储内存使用量要受到进程空间的限制，超出了就会出现进程分配不出的异常，
  通常会导致进程异常和退出，在线用户数多了影响系统稳定性
* 如果将会话存储保存在磁盘或者其他进程(本机的或者跨网络共享的)，那么应用服务器要使用会话的时候，
 无论是框架访问servlet前自动将当前会话的数据提前取得提供，
 还是应用servlet代码自己去取会话存储的内容，性能开销影响和servlet本身的处理量比都显得过大。
* 维护专门的会话存储服务也是额外的管理维护开销，同时增加故障点

### 服务端会话影响系统处理能力的伸缩性

  有了服务端会话，如果服务进程采用集群方式多进程多服务器部署，那么必须要确保一个用户的访问子会话建立起该用户的所有访问必须路由到相同的服务主机和服务进程上去，这就影响了集群的效果.

noradle 采用 signed cookie 机制来实现 session 的功能
------------------------------------------------------

（注：noradle 目前也提供保存在 [noradle-http][] 中的服务器端会话，但是将会废弃并过渡到基于签名cookie的方案上）

### cookie 直接包含会话信息

优势:

* 服务端没有保存和清理会话数据的负担
* 服务端无状态，可以支持大规模的 cluster，扩展性更好
* cluster 节点分配更自由，可以完全按照节点的负载来分配，没有会话 affinity
* 可以采用 signed cookie 来确保发送来的 cookie 的确是服务器端生成的，而不是伪造的
* 可以将所有的会话信息打包到一个 cookie 值中，更加方便
* 进一步进行加密，防止在非 https 通道上被监听

劣势：

* 会话内容总要在浏览器和web服务器间传递，网络传输负担加重，不经济
* 会话内容存在在传输中被截获和解密的可能(当然使用 https 通道的话，不存在此问题)

适用场合：

* 用户量大访问量超大的网站，支持大规模无状态集群
* 会话内容不涉及需保密的内容（会话登录人身份不在此列）

## signed cookie

对 cookie value 使用 secret 来签名(sign)，将确保请求中的 cookie 都是来自服务器的设置，而不是随意伪造的。

但是 signed cookie 也不是非常的有意义，因为：

* 如果持有安全信息，如当前登录人身份等，那么该信息将会在网络中明码传输(除非是采用 https 访问)，可能被有目的的根据取值选择性截获
，然后被偷走全部cookie信息
* 如果持有的是非安全信息，那么也不需要签名

因此，可以认为 signed cookie 唯一的作用就是降低对服务端会话的依赖。

* 对 cookie 取值使用 secret 加密，signed cookie 名称必须为 $ 开头
* 在 oracle 侧只提供 value，在 node.js 侧进行 sign，使用在 node.js 侧的配置 secret
* node.js 在分析 cookie 的时候，如果是 $ 开头的 cookie，就解密，如果发现不是自己 signed，则抛弃，相当于没有此 cookie

  [noradle-http]: https://github.com/noradle/noradle-http
  
